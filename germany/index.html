<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    <title>Hidden Germany footage</title>
</head>

<body>
    <div id="loading">â˜• loading map</div>
    <div id="mapid"></div>

    <script>
        (async function () {
            async function loadPanos() {
                const response = await fetch("./germany_footage.json");
                const json = await response.json();
                return json;
            }

            var map = L.map("mapid", {
                center: [51.163361, 10.447683],
                minZoom: 6,
                zoom: 6,
                preferCanvas: true,
                zoomControl: true,
            });

            const roadTiles = L.tileLayer(
                "https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m8!1e0!2ssvv!4m2!1scb_client!2sapiv3!4m2!1scc!2s*211m3*211e2*212b1*213e2!3m3!3sUS!12m1!1e1!4e0",
                {
                    maxZoom: 19,
                    zIndex: 1,
                }
            ).addTo(map);

            const satTiles = L.tileLayer(
                "https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m8!1e1!2ssvv!4m2!1scb_client!2sapiv3!4m2!1scc!2s*211m3*211e2*212b1*213e2!3m3!3sUS!12m1!1e1!4e0",
                {
                    maxZoom: 19,
                    zIndex: 1,
                }
            );
            const satLabelsTiles = L.tileLayer(
                "https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i0!3m12!2sen!3sUS!5e18!12m4!1e68!2m2!1sset!2sRoadmapSatellite!12m3!1e37!2m1!1ssmartmaps!4e0",
                {
                    maxZoom: 19,
                    zIndex: 2,
                }
            );

            const blueLineTiles = L.tileLayer(
                "https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m8!1e2!2ssvv!4m2!1scb_client!2sapiv3!4m2!1scc!2s*211m3*211e2*212b1*213e2!3m3!3sUS!12m1!1e68!4e0",
                {
                    maxZoom: 19,
                    zIndex: 5,
                }
            ).addTo(map);

            const maxRasterLayer = 11;

            const footageRasterLayer = L.tileLayer(
                "./tiles/{z}/{x}/{y}.png",
                {
                    minZoom: 6,
                    maxZoom: maxRasterLayer,
                    opacity: 0.95,
                    zIndex: 999,
                }
            ).addTo(map);

            const notification = document.getElementById("loading");
            notification.style.visibility = "visible";
            const panos = await loadPanos();
            const footageVectorLayer = L.vectorGrid.slicer(panos, {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    sliced: function (properties, zoom) {
                        const radius = 0.25 * zoom;
                        const color = properties.working
                            ? "#2579d2"
                            : "#f30010";
                        return {
                            radius: radius,
                            fillColor: color,
                            color: color,
                            fill: true,
                        };
                    },
                },
                interactive: true,
                minZoom: maxRasterLayer + 1,
                maxZoom: 19,
                opacity: 0.95,
                zIndex: 999,
            })
                .on('click', function (e) {
                    const properties = e.layer.properties;
                    let content = `
          <a target='_blank'
          href='https://www.google.com/maps/@${e.latlng.lat},${e.latlng.lng},3a,75y,0h,90t/data=!3m6!1e1!3m4!1s${properties.id}!2e0!7i13312!8i6656'>
            ${properties.id}</a><br>
            ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                    if (properties.year) {
                        content += `<br>${properties.year}-${properties.month.toString().padStart(2, "0")}`;
                    }
                    if (properties.first_found) {
                        content += `<br>found: ${new Date(properties.first_found * 1000).toLocaleString("de-DE")}`;
                    }

                    L.popup().setContent(content)
                        .setLatLng(e.latlng)
                        .openOn(map);
                });
            footageVectorLayer.addTo(map);
            notification.style.visibility = "hidden";

            const satGroup = L.layerGroup([satTiles, satLabelsTiles]);
            const footageGroup = L.layerGroup([footageRasterLayer, footageVectorLayer]).addTo(map);

            const baseLayers = {
                "Road": roadTiles,
                "Satellite": satGroup,
            };
            const overlays = {
                "Blue lines": blueLineTiles,
                "Hidden footage": footageGroup,
            };
            L.control.layers(baseLayers, overlays).addTo(map);


        })();
    </script>
</body>
</html>